name: Claude Code PR Review with Progress Tracking

# This example demonstrates how to use the track_progress feature to get
# visual progress tracking for PR reviews, similar to v0.x agent mode.

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  review-with-tracking:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: PR Review with Progress Tracking
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Enable progress tracking
          track_progress: true

          # Your custom review instructions
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            **Respond in Korean language (í•œêµ­ì–´ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”).**

            Perform a comprehensive code review with the following focus areas:

            1. **Code Quality**
               - Code should be self-explanatory and easy for humans to understand
               - Clean code principles and best practices
               - Proper error handling and edge cases
               - Code readability and maintainability
               - Apply these principles pragmatically - don't over-engineer simple code

            2. **Security**
               - Check for potential security vulnerabilities
               - Validate input sanitization
               - Review authentication/authorization logic

            3. **Performance**
               - Identify potential performance bottlenecks
               - Review database queries for efficiency
               - Check for memory leaks or resource issues

            4. **Testing**
               - Verify adequate test coverage
               - Review test quality and edge cases
               - Check for missing test scenarios

            5. **Documentation**
               - Ensure code is properly documented
               - Verify README updates for new features
               - Check API documentation accuracy

            Provide detailed feedback using inline comments for specific issues.
            
            ## Review Response Format

            **IMPORTANT: You MUST strictly follow the format below. Do NOT deviate from this structure.**
            **The main PR review comment MUST use this exact template format:**
            **Review language: Korean**
            
            ```markdown
            ## ğŸ“‹ PR Review Summary
            
            **Status**: [Choose one: âœ… Approved | ğŸ”„ Request Changes | ğŸ’¬ Comment Only]
            **Reviewed by**: Claude Code Review Bot
            **Review Date**: [Current Date]
            
            ---
            
            ### ğŸ“ Overview
            [1-3 sentences summarizing the PR's purpose and overall code quality assessment]
            
            ---
            
            ### ğŸ”´ Critical Issues (Must Fix Before Merge)
            > Issues that block merging - security vulnerabilities, bugs, data loss risks
            
            | Priority | File | Line | Issue | Recommendation |
            |----------|------|------|-------|----------------|
            | ğŸ”´ P0 | `filename.kt` | L## | [Brief description] | [Fix suggestion] |
            
            *None found* (if no critical issues)
            
            ---
            
            ### ğŸŸ  Major Issues (Should Fix)
            > Significant problems - performance issues, code quality concerns, missing validation
            
            | Priority | File | Line | Issue | Recommendation |
            |----------|------|------|-------|----------------|
            | ğŸŸ  P1 | `filename.kt` | L## | [Brief description] | [Fix suggestion] |
            
            *None found* (if no major issues)
            
            ---
            
            ### ğŸŸ¡ Minor Issues (Consider Fixing)
            > Code improvements - better naming, refactoring opportunities, minor optimizations
            
            | Priority | File | Line | Issue | Recommendation |
            |----------|------|------|-------|----------------|
            | ğŸŸ¡ P2 | `filename.kt` | L## | [Brief description] | [Fix suggestion] |
            
            *None found* (if no minor issues)
            
            ---
            
            ### ğŸŸ¢ Suggestions & Nitpicks (Optional)
            > Style preferences, alternative approaches, nice-to-haves
            
            - `filename.kt:##` - [Suggestion description]
            
            *None* (if no suggestions)
            
            ---
            
            ### â“ Questions for Author
            > Clarifications needed to complete the review
            
            - [ ] `filename.kt:##` - [Question]
            
            *No questions* (if none)
            
            ---
            
            ### ğŸŒŸ Highlights (Good Practices Observed)
            > Positive feedback - well-written code, good patterns, excellent tests
            
            - `filename.kt` - [What was done well]
            
            ---
            
            ### ğŸ“Š Review Statistics
            
            | Category | Count |
            |----------|-------|
            | Files Reviewed | ## |
            | Critical Issues | ## |
            | Major Issues | ## |
            | Minor Issues | ## |
            | Suggestions | ## |
            
            ---
            
            ### ğŸ“Œ Checklist Summary
            
            - [ ] ğŸ”’ Security: [Pass/Fail/N/A] - [Brief note]
            - [ ] âš¡ Performance: [Pass/Fail/N/A] - [Brief note]
            - [ ] ğŸ§ª Testing: [Pass/Fail/N/A] - [Brief note]
            - [ ] ğŸ“š Documentation: [Pass/Fail/N/A] - [Brief note]
            - [ ] ğŸ—ï¸ Architecture: [Pass/Fail/N/A] - [Brief note]
            
            ---
            
            ### ğŸ’¬ Additional Notes
            [Any other observations, recommendations for future improvements, or context]
            
            ---
            
            <details>
            <summary>ğŸ“ Inline Comments Posted</summary>
            
            | File | Line | Type | Summary |
            |------|------|------|---------|
            | `file.kt` | L## | ğŸ”´/ğŸŸ /ğŸŸ¡/ğŸŸ¢ | [Brief summary] |
            
            </details>
            ```
            
            ---
            
            ## Comment Prefix Convention for Inline Comments
            
            When posting inline comments, use these prefixes:
            
            - `ğŸ”´ [BLOCKING]` - Must fix before merge
            - `ğŸŸ  [MAJOR]` - Should fix, significant issue
            - `ğŸŸ¡ [MINOR]` - Consider fixing, code quality
            - `ğŸŸ¢ [NIT]` - Optional, style/preference
            - `ğŸ’¡ [SUGGESTION]` - Alternative approach
            - `â“ [QUESTION]` - Needs clarification
            - `ğŸ‘ [PRAISE]` - Positive feedback
            
            Example inline comment:
            ```
            ğŸŸ  [MAJOR] N+1 ì¿¼ë¦¬ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            
            **ë¬¸ì œì **: `findAll()` í›„ ê° ì—”í‹°í‹°ì—ì„œ ì—°ê´€ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ë©´ N+1 ì¿¼ë¦¬ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
            
            **ê¶Œì¥ ìˆ˜ì •**:
            \`\`\`kotlin
            @EntityGraph(attributePaths = ["orders"])
            fun findAllWithOrders(): List<User>
            \`\`\`
            ```

          # Tools for comprehensive PR review
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"

# When track_progress is enabled:
# - Creates a tracking comment with progress checkboxes
# - Includes all PR context (comments, attachments, images)
# - Updates progress as the review proceeds
# - Marks as completed when done